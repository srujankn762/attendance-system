name: PR Summary Email

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  pr-summary-email:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository with full history
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Important: fetch full history

      # Step 2: Get PR details and changed files
      - name: Get PR details
        id: pr_info
        run: |
          echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "pr_body=${{ github.event.pull_request.body }}" >> $GITHUB_ENV
          echo "pr_url=${{ github.event.pull_request.html_url }}" >> $GITHUB_ENV

          # Fetch PR merge commit
          git fetch origin +refs/pull/${{ github.event.pull_request.number }}/merge

          # Fetch base branch explicitly
          git fetch origin ${{ github.event.pull_request.base.ref }}

          # Get changed files between base branch and PR merge commit
          CHANGED_FILES=$(git diff --name-status origin/${{ github.event.pull_request.base.ref }}...FETCH_HEAD | sed 's/^/* /')
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_ENV

      # Step 3: Generate PR summary using Google Gemini
      - name: Generate PR summary
        id: summary
        run: |
          PROMPT="Summarize the following PR for the repository owner:\nTitle: ${{ env.pr_title }}\nBody: ${{ env.pr_body }}\nChanged Files:\n${{ env.changed_files }}"

          RESPONSE=$(curl -s -X POST "https://gemini.googleapis.com/v1beta/llm:generateText" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.GOOGLE_GEMINI_API_KEY }}" \
            -d "{
                  \"model\": \"gemini-1.5-mini\",
                  \"prompt\": \"$PROMPT\",
                  \"temperature\": 0.5,
                  \"maxOutputTokens\": 500
                }" | jq -r '.candidates[0].output')

          echo "pr_summary=$RESPONSE" >> $GITHUB_ENV

      # Step 4: Send email via Gmail SMTP
      - name: Send email via SMTP
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "New PR: #${{ github.event.pull_request.number }} - ${{ env.pr_title }}"
          body: |
            A new Pull Request has been created.

            PR Link: ${{ env.pr_url }}

            Changed Files:
            ${{ env.changed_files }}

            PR Summary:
            ${{ env.pr_summary }}
          to: ${{ secrets.REPO_OWNER_EMAIL }}
          from: ${{ secrets.SMTP_USERNAME }}
          secure: true
